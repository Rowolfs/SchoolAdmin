// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///
/// –ú–æ–¥–µ–ª—å Class: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞—Å—Å–∞—Ö, –∏—Ö —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è—Ö –∏ —Å–≤—è–∑–∏ —Å –∂—É—Ä–Ω–∞–ª–æ–º
///
model Class {
  id           Int                              @id @default(autoincrement())
  name         String                           @unique
  classTeacher Int?                             @unique
  teacher      Teacher?                         @relation("ClassTeacher", fields: [classTeacher], references: [id], onDelete: SetNull)
  pupils       Pupil[]

  // –ó–∞–ø–∏—Å–∏ ¬´—É—á–∏—Ç–µ–ª—å‚Äì–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫/–æ—Ü–µ–Ω–∫–∞¬ª
  journalEntries DisciplineTeacherPupilsMark[]  @relation("ClassJournalEntries")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
}

///
/// –ú–æ–¥–µ–ª—å Discipline: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ —Å–≤—è–∑–∏ —Å –∂—É—Ä–Ω–∞–ª–æ–º
///
model Discipline {
  id                  Int                             @id @default(autoincrement())
  name                String
  description         String

  // –°–≤—è–∑—å ¬´—É—á–∏—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥–µ—Ç —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç¬ª
  disciplineTeachers  DisciplineTeacher[]

  // –ó–∞–ø–∏—Å–∏ ¬´—É—á–∏—Ç–µ–ª—å‚Äì–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫/–æ—Ü–µ–Ω–∫–∞¬ª
  journalEntries      DisciplineTeacherPupilsMark[]  @relation("DisciplineJournalEntries")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?
}

///
/// –ú–æ–¥–µ–ª—å Teacher: —É—á–∏—Ç–µ–ª—å, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏ —Å–≤—è–∑–∏ —Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏/–∂—É—Ä–Ω–∞–ª–æ–º
///
model Teacher {
  id                    Int                             @id @default(autoincrement())
  userId                Int                             @unique
  classroomNumber       String?

  user                  User                            @relation("UserTeacher", fields: [userId], references: [id], onDelete: Cascade)
  
  // –°–≤—è–∑—å ¬´–∫–∞–∫–æ–π —É—á–∏—Ç–µ–ª—å –≤–µ–¥–µ—Ç –∫–∞–∫–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã¬ª
  disciplines           DisciplineTeacher[]


  // –ï—Å–ª–∏ —ç—Ç–æ—Ç —É—á–∏—Ç–µ–ª—å ‚Äì –∫–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å
  classTaught           Class[]                         @relation("ClassTeacher")

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  deletedAt             DateTime?
}

///
/// –ú–æ–¥–µ–ª—å DisciplineTeacher: —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—á–∏—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–º–µ—Ç.
/// –ù–∞ –Ω–µ—ë —Å—Å—ã–ª–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞.
///
model DisciplineTeacher {
  id            Int                             @id @default(autoincrement())
  disciplineId  Int
  teacherId     Int

  discipline    Discipline                      @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  teacher       Teacher                         @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // –ó–∞–ø–∏—Å–∏ ¬´—É—á–∏—Ç–µ–ª—å‚Äì–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫/–æ—Ü–µ–Ω–∫–∞¬ª
  journalEntries DisciplineTeacherPupilsMark[]  @relation("DisciplineTeacherJournalEntries")

  @@unique([disciplineId, teacherId])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
}

///
/// –ú–æ–¥–µ–ª—å Pupil: —É—á–µ–Ω–∏–∫, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∫–ª–∞—Å—Å—É, –∏ —Å–≤—è–∑—å —Å –∂—É—Ä–Ω–∞–ª–æ–º
///
model Pupil {
  id                 Int                             @id @default(autoincrement())
  userId             Int                             @unique
  classId            Int?

  user               User                            @relation("UserPupil", fields: [userId], references: [id], onDelete: Cascade)
  class              Class?                          @relation(fields: [classId], references: [id], onDelete: Restrict)

  // –ó–∞–ø–∏—Å–∏ ¬´—É—á–∏—Ç–µ–ª—å‚Äì–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫/–æ—Ü–µ–Ω–∫–∞¬ª
  journalEntries     DisciplineTeacherPupilsMark[]  @relation("PupilJournalEntries")

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  deletedAt          DateTime?
}

///
/// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è —Å–≤—è–∑–µ–π ¬´–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì—É—á–∏—Ç–µ–ª—å‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫‚Äì–æ—Ü–µ–Ω–∫–∞¬ª
///



///
/// –ú–æ–¥–µ–ª—å DisciplineTeacherPupilsMark: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è —Å–≤—è–∑–µ–π ¬´–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞‚Äì—É—á–∏—Ç–µ–ª—å‚Äì–∫–ª–∞—Å—Å‚Äì—É—á–µ–Ω–∏–∫‚Äì–æ—Ü–µ–Ω–∫–∞¬ª
///
model DisciplineTeacherPupilsMark {
  id                   Int                  @id @default(autoincrement())
  disciplineTeacherId  Int
  classId              Int
  pupilId              Int?
  mark                 Float?               // 1‚Äì10, nullable
  quarter              Int?                 // 1‚Äì4, nullable

  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  deletedAt            DateTime?            // üëà soft delete

  disciplineTeacher    DisciplineTeacher    @relation("DisciplineTeacherJournalEntries", fields: [disciplineTeacherId], references: [id], onDelete: Cascade)
  class                Class                @relation("ClassJournalEntries", fields: [classId], references: [id], onDelete: Cascade)
  pupil                Pupil?               @relation("PupilJournalEntries", fields: [pupilId], references: [id], onDelete: SetNull)

  // Opposite relation for Discipline.journalEntries
  discipline           Discipline           @relation("DisciplineJournalEntries", fields: [disciplineTeacherId], references: [id], map: "DisciplineTeacherPupilsMark_disciplineTeacherId_discipline_fkey")

  @@unique([disciplineTeacherId, classId, pupilId, quarter], name: "uniq_dtp_pupil_quarter")
}



///
/// –ú–æ–¥–µ–ª—å User: —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏)
///
model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  roleId     Int
  name       String
  surname    String
  patronymic String

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  role       Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  teacher    Teacher?  @relation("UserTeacher")
  pupil      Pupil?    @relation("UserPupil")
}

///
/// –ú–æ–¥–µ–ª—å Role: —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
///
model Role {
  id         Int       @id @default(autoincrement())
  name       String    @unique

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  users      User[]
}
